C51 COMPILER V9.00   HC_SR04                                                               11/07/2015 21:08:48 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE HC_SR04
OBJECT MODULE PLACED IN HC-SR04.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE user\HC-SR04.c BROWSE DEBUG OBJECTEXTEND PRINT(.\HC-SR04.lst) OBJECT(HC-SR0
                    -4.obj)

line level    source

   1          /******************************************************************************/
   2          /* 项目名称  : TX-1C扩展板 超声波测距                                         */
   3          /* 主控芯片  : STC89C52                                                       */
   4          /* 文件名称  : UltraSonic                                                     */
   5          /* 文件功能  : 超声波模块操作                                                 */
   6          /* 文件版权  : 北京海克智动科技有限公司                                       */
   7          /* 文件版本  :                                                                */
   8          /******************************************************************************/
   9          /**********************************包含头文件**********************************/
  10          #include <reg52.h>
  11          #include "1602.h"
*** WARNING C318 IN LINE 11 OF user\HC-SR04.c: can't open file '1602.h'
  12          /************************************宏定义************************************/
  13          #define VELOCITY_30C    3495       //30摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  14          #define VELOCITY_23C    3453       //23摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  15          /************************************位定义************************************/
  16          sbit INPUT  = P0^2;                //回声接收端口
  17          sbit OUTPUT = P0^1;                //超声触发端口
  18          sbit Beep   = P2^3 ;                       // 蜂鸣器　
  19          /********************************定义变量和数组********************************/
  20          long int distance=0;               //距离变量
  21          uchar table[]="    Welcome to   ";
*** ERROR C129 IN LINE 21 OF USER\HC-SR04.C: missing ';' before 'table'
  22          uchar table0[]="  www.txmcu.com  ";
  23          uchar table1[]="There's no echo.";
  24          uchar table2[]="  www.txmcu.com  ";
  25          uchar table3[]="Distance:";
  26          uchar count;
  27          /***********************************函数声明***********************************/
  28          extern void initLCD();
  29          extern void write_date(uchar date);
  30          extern void write_com(uchar com);
  31          extern void delay(uint x);
  32          /******************************************************************************/
  33          /* 函数名称  : Delay_xMs                                                      */
  34          /* 函数描述  : 延时函数                                                       */
  35          /* 输入参数  : x                                                              */
  36          /* 参数描述  : 延时时间                                                       */
  37          /* 返回值    : 无                                                             */
  38          /******************************************************************************/
  39          void Delay_xMs(unsigned int x)
  40          {
  41              unsigned int i,j;
  42              for(i = 0;i < x;i++ )
  43              {
  44                  for(j = 0;j < 3;j++ )
  45                  {
  46                      ;
  47                  }
  48              }
  49          }
  50          /******************************************************************************/
  51          /* 函数名称  : Alarm                                                          */
  52          /* 函数描述  : 蜂鸣器发声函数                                                 */
C51 COMPILER V9.00   HC_SR04                                                               11/07/2015 21:08:48 PAGE 2   

  53          /* 输入参数  : t                                                              */
  54          /* 参数描述  : 发声的次数                                                     */
  55          /* 返回值    : 无                                                             */
  56          /******************************************************************************/
  57          void Alarm(uchar t)
  58          {
  59                  uchar i;
  60                  for(i = 0;i < t;i++)
  61                  {
  62                          Beep = 0;
  63                          Delay_xMs(1000);
  64                          Beep = 1;
  65                          Delay_xMs(1000);
  66                  }
  67          }       
  68          /******************************************************************************/
  69          /* 函数名称  : delayt                                                         */
  70          /* 函数描述  : 延时函数                                                       */
  71          /* 输入参数  : x                                                              */
  72          /* 参数描述  : 延时时间数据                                                   */
  73          /* 返回值    : 无                                                             */
  74          /******************************************************************************/        
  75          void delayt(uint x)
  76          {
  77              uchar j;
  78              while(x-- > 0)
  79              {
  80                      for(j = 0;j < 125;j++)
  81                  {
  82                      ;
  83                  }
  84              }
  85          }
  86          /******************************************************************************/
  87          /* 函数名称  : Init_MCU                                                       */
  88          /* 函数描述  : 初始化单片机函数                                               */
  89          /* 输入参数  : 无                                                             */
  90          /* 参数描述  : 无                                                             */
  91          /* 返回值    : 无                                                             */
  92          /******************************************************************************/
  93          void Init_MCU(void)
  94          {
  95                  TMOD = 0x01;      //定时器0初始化,设置为16位自动重装模式
  96                  TL0 = 0xcd;
  97                  TH0 = 0xf8;           //1ms
  98              ET0 = 1;          //开定时器0
  99                  EA = 1;               //总中断使能
 100          }
 101          /******************************************************************************/
 102          /* 函数名称  : Init_Parameter                                                 */
 103          /* 函数描述  : 初始化参数和IO口函数                                           */
 104          /* 输入参数  : 无                                                             */
 105          /* 参数描述  : 无                                                             */
 106          /* 返回值    : 无                                                             */
 107          /******************************************************************************/
 108          void Init_Parameter(void)
 109          {
 110                   OUTPUT =1;
 111                   INPUT = 1;
 112                   count = 0;
 113                   distance = 0;
 114          }
C51 COMPILER V9.00   HC_SR04                                                               11/07/2015 21:08:48 PAGE 3   

 115          /******************************************************************************/
 116          /* 函数名称  : display_char                                                   */
 117          /* 函数描述  : 显示字符串函数                                                 */
 118          /* 输入参数  : point,address                                                  */
 119          /* 参数描述  : 写入的字符串的地址指针 1602显示对应的地址                      */
 120          /* 返回值    : 无                                                             */
 121          /******************************************************************************/
 122          void display_char(uchar *point,uchar address)
 123          {
 124                  uchar i;
 125                  write_com(0x80 + address);
 126                  for(i = 0;i < 16; i++)
 127                  {
 128                          write_date(*point);
 129                          point++;
 130                  }
 131          }
 132          /******************************************************************************/
 133          /* 函数名称  : display                                                        */
 134          /* 函数描述  : 显示数字                                                       */
 135          /* 输入参数  : number，address                                                */
 136          /* 参数描述  : number写入的数据，address地址                                  */
 137          /* 返回值    : 无                                                             */
 138          /******************************************************************************/        
 139          void display(int number,uchar address)
 140          {
 141                  uchar b,c,d,e;
 142                  b= (number / 1000);
 143                  c= (number / 100) % 10;
 144                  d = (number / 10) % 10;
 145                  e = number % 10;
 146          
 147                  write_com(0x80 + address);
 148              write_date(b + 48);
 149                  write_date(c + 48);
 150                  write_date(d + 48);
 151                  write_date(46);           //小数点的ASCII
 152                  write_date(e + 48);
 153              write_date(99);           //"c"的ASCII
 154                  write_date(109);          //"m"的ASCII
 155          }
 156          /******************************************************************************/
 157          /* 函数名称  : Trig_SuperSonic                                                */
 158          /* 函数描述  : 发出声波函数                                                   */
 159          /* 输入参数  : 无                                                             */
 160          /* 参数描述  : 无                                                             */
 161          /* 返回值    : 无                                                             */
 162          /******************************************************************************/
 163          void Trig_SuperSonic(void)//出发声波
 164          {
 165                   OUTPUT = 1;
 166                   delayt(1);
 167                   OUTPUT = 0;
 168          }
 169          /******************************************************************************/
 170          /* 函数名称  : Measure_Distance                                               */
 171          /* 函数描述  : 计算距离函数                                                   */
 172          /* 输入参数  : 无                                                             */
 173          /* 参数描述  : 无                                                             */
 174          /* 返回值    : 无                                                             */
 175          /******************************************************************************/
 176          void Measure_Distance(void)
C51 COMPILER V9.00   HC_SR04                                                               11/07/2015 21:08:48 PAGE 4   

 177          {
 178                  uchar l;
 179                  uint h,y;
 180                  TR0 = 1;
 181                  while(INPUT)
 182              {
 183                  ;
 184              }   
 185                  TR0 = 0;
 186                  l = TL0;
 187                  h = TH0;
 188                  y = (h << 8) + l;
 189                  y = y - 0xf8cd;//us部分
 190                  distance = y + 1000 * count;//计算总时间
 191                  TL0 = 0xcd;
 192                  TH0 = 0xf8;
 193                  delayt(30);
 194                  distance = VELOCITY_30C * distance / 20000;
 195          }
 196          /******************************************************************************/
 197          /* 函数名称  : main                                                           */
 198          /* 函数描述  : 主函数                                                         */
 199          /* 输入参数  : 无                                                             */
 200          /* 参数描述  : 无                                                             */
 201          /* 返回值    : 无                                                             */
 202          /******************************************************************************/                                        
 203          void main(void)
 204          {
 205                  initLCD();
 206                  Init_MCU();
 207                  Init_Parameter();
 208                  Alarm(2);
 209                  display_char(table,0x00);
 210                  display_char(table0,0x40);
 211                  Delay_xMs(30000);
 212                  display_char(table2,0x00);
 213                  display_char(table1,0x40);
 214          
 215                  while(1)
 216                  {
 217                           Trig_SuperSonic();         //触发超声波发射
 218                           while(INPUT == 0)          //等待回声
 219                   {
 220                       ;
 221                   }
 222                           Measure_Distance();        //计算脉宽并转换为距离
 223                           display_char(table3,0x40);
 224                           display(distance,0x49);    //显示距离
 225                           Init_Parameter();          // 参数重新初始化
 226                           delayt(100);               //延时，两次发射之间要至少有10ms间隔
 227                   }      
 228          }
 229          

C51 COMPILATION COMPLETE.  1 WARNING(S),  1 ERROR(S)
